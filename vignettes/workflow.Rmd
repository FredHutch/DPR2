---
title: "Typical DPR2 Workflow"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Typical DPR2 Workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

# Temporary working directory for example data package

twd <- tempfile('vpkg')
dir.create(twd)
knitr::opts_knit$set(root.dir = twd)
```

### Load DPR2

```{r setup}
library(DPR2)
```

### Initialize a new DPR2 package

```{r create}

# Use the current working directory for the new data package

dpr_init(twd,renv_init = FALSE)

# View the files created by dpr_init()

list.files(twd)

# Alternatively, create a new DPR2 package in a different directory
# dpr_create(path = "path_to_different_dir")
```

### Examine datapackager.yml

```{r yaml}
cat(readLines(paste0(twd,'\\','datapackager.yml')), sep = '\n')
```
Current configuration on the YAML file can be viewed with `dpr_yaml_get()`

```{r}
dpr_yaml_get(twd)
```
Main components of the YAML config files are the `process_directory` where all the scripts which are to be rendered are saved, `source_data_directory` which contains the data_objects to be rendered. `render_env_mode` does what ?


```{r yaml}
cat(readLines(paste0(twd,'\\','datapackager.yml')), sep = '\n')
```

Any YAML configurations can be changed by the user with dpr_yaml_set(). In the example, we are changing the argument `render_on_build` to `no` which indicates objects and files will not be rendered at build

```{r}
dpr_yaml_set(twd,render_on_build = FALSE)
cat(readLines(paste0(twd,'\\','datapackager.yml')), sep = '\n')
```


Sometimes we may encounter datapacakges created by DPR1 . DPR2 has function `dpr_dpr1_yaml_load` which converts a DPR1 YAML object into a DPR2 compatible yaml object

```{r}
#existing dpr1 project
library(DataPackageR)
library(yaml)
my_temp_dir <- tempdir()
#setup an empty DPR1 skeleton
processing_code <-
    system.file("extdata", "tests", "subsetCars.Rmd", package = "DataPackageR")

# Create the package framework.
DataPackageR::datapackage_skeleton(name = "mtcars20",
                                   force = TRUE,
                                   code_files = processing_code,
                                   r_object_names = "cars_over_20",
                                   path = my_temp_dir 
                                   #dependencies argument is empty
                                   #raw_data_dir argument is empty.
                                   )
yml <- DataPackageR::construct_yml_config(code = "subsetCars.Rmd", data = "cars_over_20")

cat(yaml::as.yaml(yml))
```
After using dpr_dpr1_yaml_convert function and loading and looking over the yaml settings, we see the yaml configuration for the DPR1 package is converted to DPR2 compatible settings:
```{r}
dpr_dpr1_yaml_convert(file.path(my_temp_dir, "mtcars20"))
dpr_yaml_get(path = file.path(my_temp_dir, "mtcars20") )
```




```{r add-processing-script, echo = FALSE}
writeLines(
    c(
      "---",
      "title: example processing script",
      "---",
      "Example text",
      "",
      "```{r}",
      "library(DPR2)",
      "my_df <- data.frame(a = 1:5, b = letters[1:5])",
      "dpr_save('my_df')",
      "```"
    ),
    dpr_path(twd,"processing", "make_my_df.Rmd")
  )
```

### View example processing script

Note: Use `dpr_path()` to refer to other paths within processing scripts and `dpr_save()` to save objects to `data/`.

```{r view-processing-script}
cat(readLines(dpr_path(twd,'processing', 'make_my_df.Rmd')), sep = '\n')
```

### Build the data package

```{r build}
dpr_build(path = twd,process_on_build = 'make_my_df.Rmd')

# examine data directory

list.files(twd,recursive = TRUE)
```

### Examine the data digest

```{r examine-data-digest}

dd_file <- list.files(paste0(twd,dpr_path('inst', 'data_digest')), full.names = TRUE)
dd_file

cat(readLines(dd_file), sep = '\n')

```

### Examine the saved data object

```{r object}
load(dpr_path('data', 'my_df.rda'))
my_df
```
