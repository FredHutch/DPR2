---
title: "Data Documentation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Data Documentation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Introduction

Clear documentation of data objects allows users to quickly understand the structure, variables, and intended purpose of each dataset without having to inspect the raw contents. This is especially important in packages where data evolves over time or supports multiple analysis pipelines. Well-documented data reduces onboarding time, minimizes errors, and promotes consistent use and interpretation across workflows.

DPR2 offers features that automatically generate documentation for `.rda` data objects stored in a package’s `data/` folder. This includes creating `.R` files for each object under `R/`, as well as `.Rd` help files in `man/` using `roxygen2`. Descriptive details are added based on the object’s structure. For example, the number of rows and columns are shown for data frames or matrices, and the length is shown for vectors and lists.

Below, we explain how this works, demonstrate its behavior on example objects, and cover important edge cases. Let's begin by showing a directory skeleton of an example DPR2 package `TestPKG` prior to rendering to showcase the absence of the `man/` and `R/` folders.

```{r, include=FALSE}
library(DPR2)

temp_dir <- file.path(tempdir(), "examplepackages")
dir.create(temp_dir)
dpr_create(path = temp_dir, desc=dpr_description_init(Package= "TestPKG"))
path <- file.path(temp_dir, "TestPKG")

code_block <- c(
  "library(DPR2)",
  "",
  "data('mtcars')",
  "mtcars_df <- mtcars",
  "mtcars_df$efficiency <- mtcars$mpg / mtcars$hp",
  "",
  "mtcars_list <- list(
  raw_data = mtcars,
  summary = summary(mtcars),
  column_classes = sapply(mtcars, class),
  correlation_matrix = cor(mtcars)
  )",
  "dpr_save('mtcars_df')",
  "dpr_save('mtcars_list')"
)

writeLines(
  code_block,
  file.path(path, "processing/mtcars.R")
)

suppressWarnings(try(source(file.path(path, "processing/mtcars.R")), silent = T))

dpr_add_scripts("mtcars.R", path)

```


```bash
TestPKG
├── data
├── datapackager.yml
├── DESCRIPTION
├── inst
│   ├── data_digest
│   ├── extdata
│   └── to_build
│       ├── objects
│       └── scripts
│           └── mtcars.R_
├── NAMESPACE
└── processing
    └── mtcars.R
```

We now walk through an example using the built-in `mtcars` dataset. This will show how DPR2 documents both a data frame and a structured list object.

# Automated, simple documentation with DPR2

DPR2 automatically generates documentation for each `.rda` object in the `data/` folder upon calling `dpr_render()`. The `.R` and `.Rd` files are created by examining the object’s structure, including its class, dimensions, and element names. Field descriptions are inferred from column names in data frames or element names in lists.

DPR2 leverages `dpr_compare_data_digest()` to compare the checksums of objects in the `data/` directory with their recorded digests. This allows DPR2 to update `.R` documentation files only when changes are detected in the underlying data. **By default, DPR2 will overwrite `.R` and `.Rd` files if the corresponding data object has changed, as determined by its checksum. If the object has not changed, DPR2 will skip re-documentation.** 

Below we walk through an example showcasing DPR2's default documentation behavior. We define and save two objects: an `mtcars_df` data frame that has an added `efficiency` column, and a `mtcars_list` list containing the raw data, summary statistics, column classes, and a correlation matrix. These are saved to the `data/` folder using `dpr_save()`.

```{r, echo=FALSE, results='asis'}
cat(
  "```",
  code_block,
  "```",
  sep = "\n"
)
```

```{r, comment="#>", collapse=TRUE}
str(mtcars_df)

```

```{r, comment="#>", collapse=TRUE}
str(mtcars_list)

```

After calling `dpr_render()`, DPR2 generates `.R` files under `R/` and `.Rd` files under `man/`.

```{r, include=FALSE}
dpr_render(path)

```

```bash
TestPKG
├── data
│   ├── mtcars_df.rda
│   └── mtcars_list.rda
├── man
│   ├── mtcars_df.Rd
│   └── mtcars_list.Rd
├── processing
│   └── mtcars.R
└── R
    ├── mtcars_df.R
    └── mtcars_list.R

```

Below is the content for `mtcars_df.R` and `mtcars_list.R` files.

```{r, echo=FALSE, results='asis'}
cat(
  "```",
  readLines(file.path(path, "R", "mtcars_df.R")),
  "```",
  sep = "\n"
)
```

```{r, echo=FALSE, results='asis'}
cat(
  "```",
  readLines(file.path(path, "R", "mtcars_list.R")),
  "```",
  sep = "\n"
)
```

Users can now access documentation with `?mtcars_df` or `?mtcars_list`, just like any standard R data package.

# Advanced documentation with DPR2

Users are able to modify the `.R` file templates generated by DPR2 and provide further details on their data objects such as context, descriptions, and references. In the example below, we update the `@source` tag to link the object back to its processing script. 

```{r, message=FALSE}
mtcars_block <- readLines(file.path(path, "R", "mtcars_df.R"))
mtcars_block[grepl("@source", mtcars_block)] <- "#' @source Generated from script mtcars.R"
writeLines(mtcars_block, file.path(path, "R", "mtcars_df.R"))

roxygen2::roxygenize(path)

```

We now display the updated `.Rd` help file for `mtcars_df`:

```{r, echo=FALSE, results='asis'}
cat(
  "```",
  readLines(file.path(path, "man", "mtcars_df.Rd")),
  "```",
  sep = "\n"
)
```

Since existing documentation files are overwritten when a checksum change is detected, users are encouraged to separately save any custom edits so they can be copied into the updated version if needed. 

## Controlling what gets documented

As noted earlier, DPR2 uses `dpr_compare_data_digest()` to track changes to objects in the `data/` directory and determine how documentation should be handled:

- If an existing `.rda` file has changed, the corresponding `.R` and `.Rd` files are automatically overwritten.
- If the `.rda` file is unchanged, DPR2 preserves existing documentation and does not overwrite `.R` or `.Rd` files.
- If an object is no longer present in the `data/` directory, DPR2 deletes the corresponding `.R` and `.Rd` files during rendering.

This behavior keeps the documentation in sync with the underlying data while avoiding unnecessary overwrites when no changes are detected.

If no new objects have been added and no existing objects have changed, DPR2 outputs a message indicating that no data documentation was generated. This lets users confirm that documentation is up to date without triggering unnecessary updates.

For example, after re-running `dpr_render()` with no changes to the saved objects, users will see the following:

```{r, include=FALSE}
code_block <- c(
  "library(DPR2)",
  "",
  "data('mtcars')",
  "mtcars_df <- mtcars",
  "mtcars_df$efficiency <- mtcars$mpg / mtcars$hp",
  "",
  "dpr_save('mtcars')"
)

writeLines(
  code_block,
  file.path(path, "processing/mtcars.R")
)

dpr_build(path)

```

```{r, warning=TRUE}
dpr_render(path)

```

In contrast, in the example below, `mtcars_df` was removed from the processing script. DPR2 detects that the object is no longer present and deletes both `R/mtcars_df.R` and `man/mtcars_df.Rd` the next time `dpr_render()` is called.

```{r, echo=FALSE, warning=FALSE}
code_block <- c(
  "library(DPR2)",
  "data('mtcars')",
  "mtcars_list <- list(
  raw_data = mtcars,
  summary = summary(mtcars),
  column_classes = sapply(mtcars, class),
  correlation_matrix = cor(mtcars)
)",
"dpr_save('mtcars_list')"
)

writeLines(
  code_block,
  file.path(path, "processing/mtcars.R")
)

dpr_render(path)

```

```{r, echo=FALSE, results='asis'}
cat(
  "```",
  code_block,
  "```",
  sep = "\n"
)

```


```bash
TestPKG
├── R
│   └── mtcars_list.R
├── data
│   └── mtcars_list.rda
├── man
│   └── mtcars_list.Rd
└── processing
    └── mtcars.R
```

Finally, it's important to note that DPR2 will ***not*** write data documentation for `.rda` files that have more than one object saved, or if the object in the `.rda` file does not match the `.rda` file name. This is due to the unclear mapping between the filename and object name. Warning messages will be outputted to alert the user of this. To enforce best practices, use `dpr_save()`, not `save()`, to write RDA files.

```{r, echo=FALSE}

code_block <- c(
  "library(DPR2)",
  "",
  "data('mtcars')",
  "mtcars_df <- mtcars",
  "mtcars_df$efficiency <- mtcars$mpg / mtcars$hp",
  "",
  "# next line is not a best practice! Use dpr_save() instead.",
  "save('mtcars_df', file=dpr_path('data', 'my_df.rda'))",
  "dpr_save('mtcars')"
)

writeLines(
  code_block,
  file.path(path, "processing/mtcars.R")
)

```

```{r, echo=FALSE, results='asis'}
cat(
  "```",
  code_block,
  "```",
  sep = "\n"
)

```

```{r}
dpr_render(path)

```
