---
title: "Data Versioning"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Data Versioning}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

DPR2 offers features to facilitate tracking data versioning throughout a project's lifecycle. This vignette will cover those features.

```{r echo = FALSE, results = 'hide'}

library(DPR2)
dpr2 <- "../tests/testthat/dpr2package"
path <- file.path(tempdir(), "dpr2package")
file.copy(dpr2, tempdir(), recursive = TRUE)

git2r::init(path = path, branch="main")
git2r::add(repo = path, path = ".")
Sys.sleep(1) # odb_blobs appears to be ordered by when, and the smallest unit is 1 sec, adding pauses to get correct sorting
git2r::commit(repo = path, message="init commit")

suppressMessages(
  dpr_build(path)
)

git2r::add(repo = path, path = ".")
git2r::commit(repo = path, message="Our first build")

irisPath <- file.path(path, "processing/iris.R")
irisScript <- readLines(irisPath)

irisScript[
  which(irisScript == "iris$Sepal.Area <- iris$Sepal.Length *  iris$Sepal.Width")
]<-  "iris$Petal.Area <- iris$Petal.Length * iris$Petal.Width"

writeLines(irisScript, irisPath)
dpr_build(path)

git2r::add(repo = path, path = ".")
Sys.sleep(1)
git2r::commit(repo = path, message="Change sepal area to petal area.")

mtcarsPath <- file.path(path, "processing/mtcars.R")
mtcarsScript <- readLines(mtcarsPath)
mtcarsScript[which(mtcarsScript == "mazda <- mtcars[grep(\"Mazda\", row.names(mtcars)),]")] <- "mazda <- mtcars[grep(\"Mazda\", row.names(mtcars)),][1]"
writeLines(mtcarsScript, mtcarsPath)
dpr_build(path)

git2r::add(repo = path, path = ".")
Sys.sleep(1)
git2r::commit(repo = path, message="Update to mazda cars.")

treesPath <- file.path(path, "processing/trees.Rmd")
treesScript <- readLines(treesPath)
treesScript <- c(
  treesScript[1:which(treesScript == "plot(trees)")],
  "trees <- trees[1:3,]",
  treesScript[(which(treesScript == "plot(trees)")+1):length(treesScript)]
)
writeLines(treesScript, treesPath)
dpr_build(path)

git2r::add(repo = path, path = ".")
Sys.sleep(1)
git2r::commit(repo = path, message="Trees subsetting")

```

One feature that DPR2 offers is the ability to print the history of data objects from a version-controlled data package and compare them to the current version. Here we use the `dpr_data_history` function to get a listing of `rda` files, when they were created, and their git SHA-1 hashes.  We can then fetch specific versions using `dpr_recall_data_versions`.

```{r}

history <- dpr_data_history(path=path, include_checksums=TRUE)
print(history)

irisAreas <- history[history$name == "irisArea.rda",]
firstIrisHash <- irisAreas[irisAreas$when == min(irisAreas$when), "blob_git_sha1"]
lastIrisHash <- irisAreas[irisAreas$when == max(irisAreas$when), "blob_git_sha1"]

dataversions <- dpr_recall_data_versions(c(firstIrisHash, lastIrisHash), path)

```

We can use the `dpr_data_digest` function to get a table of the current hashes recorded in the data package. The last object's checksum should match what is in the `dpr_data_digest` output table.

```{r}

digest::digest(dataversions[[1]][[1]])
digest::digest(dataversions[[2]][[1]])
dpr_data_digest(path)

```

Below, we render a package before building it to compare the object checksums between the refreshed object in the data directory.

```{r}

irisPath <- file.path(path, "processing/iris.R")
irisScript <- readLines(irisPath)

irisScript <- c(
  irisScript[1:which(irisScript == "iris$Petal.Area <- iris$Petal.Length * iris$Petal.Width")],
  "iris$Sepal.Area <- iris$Sepal.Length * iris$Sepal.Width",
  irisScript[(which(irisScript == "iris$Petal.Area <- iris$Petal.Length * iris$Petal.Width") + 1): length(irisScript)]
)

writeLines(irisScript, irisPath)

```

Once we have rendered and changes are detected, we can compare datasets using `dpr_compare_data_digest`.

```{r}

dpr_render(path)
dpr_compare_data_digest(path)

```

